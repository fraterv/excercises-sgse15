var map = function() {
    emit (this.sender, this.recipients);
}

// Map above creates a document for each sender, e.g.
// { "Rosalie@enron" : [ recipient-list1, recipient-list2, ...] }
// where each recipient-list is either an array of recipients

// reduce is then called for every unique sender,
// *which has more then one entry in the list* (todo)
// (see http://docs.mongodb.org/manual/reference/command/mapReduce/#mapreduce-map-cmd)

var reduce = function(key, values) {
    var recipients = {};
    values.forEach (function(recipient) {
        if (!recipient.length) { // mass mail?
	   recipient = "BROADCAST";
        }
        if (!recipients[recipient]) {
	   recipients[recipient] = 1;
        }
	else {
           recipients[recipient] += 1;
        }
    });

    return recipients;
}

// run like this:
// db.output.drop()
// db.runCommand({mapReduce: "mails", map: map, reduce: reduce, out: "output", query: {}})
// db.output.find()
